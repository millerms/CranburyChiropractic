<link rel="stylesheet" href="{{ '/assets/css/custom.css' | relative_url }}">

<script>
// Build a Services dropdown in the masthead using _data/navigation.yml > services
window.SERVICES_MENU = {{ site.data.navigation.services | jsonify }};
var BASEURL = "{{ '/' | relative_url }}".replace(/\/$/, '');

function buildServicesDropdown() {
  var nav = document.querySelector('nav.greedy-nav');

  // Clean-up: remove any previously injected Services submenus to avoid duplicates (especially on mobile overlay)
  if (nav) {
    nav.querySelectorAll('.services-submenu').forEach(function(el){ el.parentElement && el.parentElement.classList.remove('submenu-open'); el.remove(); });
  }

  // Prefer a Services link in visible links; fall back to any top-level link
  var targetLi = null;
  var linkSets = [
    'ul.visible-links > li > a',
    'ul.hidden-links > li > a',
    'ul > li > a' // fallback for modal/other layouts
  ];
  for (var i = 0; i < linkSets.length && !targetLi; i++) {
    var candidates = nav.querySelectorAll(linkSets[i]);
    for (var j = 0; j < candidates.length; j++) {
      var a = candidates[j];
      var text = (a.textContent || '').trim().toLowerCase();
      var href = (a.getAttribute('href') || '').replace(/\/+$/, '');
      if (text === 'services' || /\/services$/i.test(href)) {
        targetLi = a.parentElement;
        break;
      }
    }
  }

  if (!targetLi) return;

  targetLi.classList.add('has-submenu');

  // Build submenu (skip the index/"All Services")
  var ul = document.createElement('ul');
  ul.className = 'submenu services-submenu';
  (window.SERVICES_MENU || []).forEach(function (item) {
    if (!item || !item.url || !item.title) return;
    var isIndex = /\/services\/?$/i.test(item.url) || /all services/i.test(item.title);
    if (isIndex) return;
    var li2 = document.createElement('li');
    var a2 = document.createElement('a');
    a2.href = BASEURL + item.url; // prefix baseurl for GitHub Pages project sites
    a2.textContent = item.title;
    li2.appendChild(a2);
    ul.appendChild(li2);
  });

  if (!ul.children.length) return;

  targetLi.appendChild(ul);
  targetLi.classList.remove('submenu-open');

  // Prevent duplicate listeners if this runs multiple times
  if (targetLi.dataset.dropdownInit === '1') return;
  targetLi.dataset.dropdownInit = '1';

  // Accessibility + interactions (hover + keyboard + click to toggle)
  var trigger = targetLi.querySelector('a');
  trigger.setAttribute('aria-haspopup', 'true');
  trigger.setAttribute('aria-expanded', 'false');

  function openMenu(){ targetLi.classList.add('submenu-open'); trigger.setAttribute('aria-expanded','true'); }
  function closeMenu(){ targetLi.classList.remove('submenu-open'); trigger.setAttribute('aria-expanded','false'); }

  targetLi.addEventListener('mouseenter', openMenu);
  targetLi.addEventListener('mouseleave', closeMenu);

  targetLi.addEventListener('focusin', openMenu);
  targetLi.addEventListener('focusout', function(e){
    if (!targetLi.contains(e.relatedTarget)) closeMenu();
  });

  // Click/tap toggle: first click opens menu; second navigates to /services/
  trigger.addEventListener('click', function (e) {
    if (!targetLi.classList.contains('submenu-open')) {
      e.preventDefault();
      openMenu();
    }
    // if already open, allow navigation to the parent Services page
  });

  // Touch support: reliably open on first tap without navigating
  trigger.addEventListener('touchstart', function (e) {
    if (!targetLi.classList.contains('submenu-open')) {
      e.preventDefault(); // needs non-passive listener
      openMenu();
    }
  }, { passive: false });

  // Keyboard support: Space/Enter toggles when closed; navigates when open; Esc closes
  trigger.addEventListener('keydown', function (e) {
    if (e.key === ' ' || e.key === 'Enter') {
      e.preventDefault();
      if (!targetLi.classList.contains('submenu-open')) {
        openMenu();
      } else {
        window.location.href = trigger.getAttribute('href');
      }
    } else if (e.key === 'Escape') {
      closeMenu();
      trigger.focus();
    }
  });

  // Close when tapping/clicking outside the menu
  document.addEventListener('click', function (evt) {
    if (!targetLi.contains(evt.target)) closeMenu();
  });
  document.addEventListener('touchstart', function (evt) {
    if (!targetLi.contains(evt.target)) closeMenu();
  }, { passive: true });

  window.addEventListener('resize', function(){ targetLi.classList.remove('submenu-open'); });
}

// Run after DOM and again after window load (in case the nav compacts/expands)
document.addEventListener('DOMContentLoaded', function(){
  buildServicesDropdown();
  // Retry once after layout settles
  setTimeout(buildServicesDropdown, 0);
});
window.addEventListener('load', buildServicesDropdown);
</script>